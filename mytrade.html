<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Trade Calculator</title>

  <!-- âœ… Compatible Chart.js + Financial Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.0/dist/chartjs-chart-financial.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: auto;
    }
    .chart-container {
      margin-top: 30px;
      background: #1e1e1e;
      padding: 20px;
      border-radius: 8px;
    }
    input, select, button {
      padding: 8px;
      margin: 5px;
    }
    .bullish {
      color: lime;
    }
    .bearish {
      color: red;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>My Trade Calculator</h2>
    
    <input type="text" id="symbolSearch" placeholder="Search coin..." oninput="filterSymbols()" />
    <select id="symbolList" size="5" style="display:none;"></select>
    <div id="marketBehavior"></div><br>

    <label>Market Price:</label>
    <input type="text" id="marketPrice" disabled /><br>

    <label>Entry Price:</label>
    <input type="number" id="entryPrice" /><br>

    <label>Margin ($):</label>
    <input type="number" id="margin" /><br>

    <label>Wallet Balance ($):</label>
    <input type="number" id="wallet" /><br>

    <label>Leverage:</label>
    <input type="number" id="leverage" /><br>

    <label>TP Price:</label>
    <input type="number" id="tpPrice" /><br>

    <label>Position:</label>
    <select id="position">
      <option value="long">Long</option>
      <option value="short">Short</option>
    </select><br>

    <label>Margin Type:</label>
    <select id="marginType">
      <option value="isolated">Isolated</option>
      <option value="cross">Cross</option>
    </select><br>

    <button onclick="calculateLiq()">Calculate</button>

    <div id="result" style="margin-top: 10px;"></div>

    <!-- Chart container -->
    <div class="chart-container">
      <canvas id="candleChart"></canvas>
    </div>
  </div>

  <script>
    let allSymbols = [];
    let selectedSymbol = '';
    let candleChart;
    const tradingFee = 0.001;

    async function loadSymbols() {
      try {
        const res = await fetch('https://api.binance.com/api/v3/exchangeInfo');
        const data = await res.json();
        allSymbols = data.symbols.map(s => s.symbol).filter(s => s.endsWith('USDT'));
      } catch (e) {
        alert("Error loading symbols.");
      }
    }

    function filterSymbols() {
      const search = document.getElementById("symbolSearch").value.toUpperCase();
      const filtered = allSymbols.filter(s => s.includes(search));
      const list = document.getElementById("symbolList");
      list.innerHTML = '';
      list.style.display = filtered.length ? 'block' : 'none';
      filtered.forEach(symbol => {
        const opt = document.createElement("option");
        opt.value = symbol;
        opt.textContent = symbol;
        list.appendChild(opt);
      });
    }

    document.getElementById("symbolList").addEventListener("change", function () {
      selectedSymbol = this.value;
      document.getElementById("symbolSearch").value = selectedSymbol;
      document.getElementById("symbolList").style.display = 'none';
      fetchPrice();
      loadCandleChart();
    });

    async function fetchPrice() {
      selectedSymbol = document.getElementById("symbolSearch").value.toUpperCase();
      if (!selectedSymbol) return alert("Please enter or select a symbol");

      try {
        const res = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${selectedSymbol}`);
        const data = await res.json();
        const price = data.price;
        if (!price) throw new Error("Price not found");
        document.getElementById("marketPrice").value = parseFloat(price).toFixed(4);
        document.getElementById("entryPrice").value = parseFloat(price).toFixed(4);

        const behavior = await getMarketBehavior();
        const behaviorEl = document.getElementById("marketBehavior");
        behaviorEl.textContent = behavior;
        behaviorEl.className = behavior.toLowerCase();
      } catch (err) {
        alert("Failed to fetch price. Please check symbol or network.");
      }
    }

    async function getMarketBehavior() {
      const url = `https://api.binance.com/api/v3/klines?symbol=${selectedSymbol}&interval=1h&limit=2`;
      const res = await fetch(url);
      const data = await res.json();
      const lastClose = parseFloat(data[1][4]);
      const prevClose = parseFloat(data[0][4]);
      return lastClose > prevClose ? 'Bullish' : 'Bearish';
    }

    async function loadCandleChart() {
      if (!selectedSymbol) return;
      if (candleChart) candleChart.destroy();

      try {
        const url = `https://api.binance.com/api/v3/klines?symbol=${selectedSymbol}&interval=1h&limit=50`;
        const res = await fetch(url);
        const data = await res.json();

        const formattedData = data.map(d => ({
          x: new Date(d[0]),
          o: parseFloat(d[1]),
          h: parseFloat(d[2]),
          l: parseFloat(d[3]),
          c: parseFloat(d[4]),
        }));

        const ctx = document.getElementById('candleChart').getContext('2d');
        candleChart = new Chart(ctx, {
          type: 'candlestick',
          data: {
            datasets: [{
              label: `${selectedSymbol} Price`,
              data: formattedData,
              upColor: 'green',
              downColor: 'red',
              borderColor: 'black'
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              x: {
                type: 'time',
                time: { unit: 'hour', tooltipFormat: 'MMM dd, HH:mm' }
              },
              y: {
                beginAtZero: false
              }
            }
          }
        });
      } catch (err) {
        console.error("Error loading chart:", err);
      }
    }

    function calculateLiq() {
      const entryPrice = parseFloat(document.getElementById("entryPrice").value);
      const margin = parseFloat(document.getElementById("margin").value);
      const wallet = parseFloat(document.getElementById("wallet").value);
      const leverage = parseFloat(document.getElementById("leverage").value);
      const position = document.getElementById("position").value;
      const marginType = document.getElementById("marginType").value;
      const tpPrice = parseFloat(document.getElementById("tpPrice").value);

      if (!entryPrice || !margin || !wallet || !leverage) return alert("Please fill all fields correctly");

      const positionSize = margin * leverage;
      const mmr = 0.005;
      const maintenanceMargin = positionSize * mmr;
      const walletToUse = marginType === "cross" ? wallet : 0;

      let liqPrice;
      if (position === "long") {
        liqPrice = (positionSize * entryPrice) / (positionSize + walletToUse - maintenanceMargin);
      } else {
        liqPrice = (positionSize * entryPrice) / (positionSize - walletToUse + maintenanceMargin);
      }

      liqPrice *= (1 - tradingFee);

      let tpProfit = '';
      if (tpPrice) {
        tpProfit = position === "long"
          ? ((tpPrice - entryPrice) * (positionSize / entryPrice))
          : ((entryPrice - tpPrice) * (positionSize / entryPrice));
        tpProfit *= (1 - tradingFee);
      }

      document.getElementById("result").innerHTML = `
        <strong style="color: red;">Estimated Liquidation Price:</strong> <span style="color: red;">$${liqPrice.toFixed(2)}</span><br>
        ${tpPrice ? `<strong style="color: green;">Estimated Profit:</strong> <span style="color: green;">$${tpProfit.toFixed(2)}</span>` : ''}
      `;
    }

    loadSymbols();
  </script>

  <!-- copyright hesper -->
</body>
</html>
